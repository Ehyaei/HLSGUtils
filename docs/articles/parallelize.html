<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to parrallelize R functions with HLSGUtils package? • HLSGUtils</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to parrallelize R functions with HLSGUtils package?">
<meta property="og:description" content="HLSGUtils">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">HLSGUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ADNI-Mixed-Effect-Models.html">ADNI Mixed Effect Models</a>
    </li>
    <li>
      <a href="../articles/genomicsUtils.html">How to use GenomicsUtils' Scala Classes in R?</a>
    </li>
    <li>
      <a href="../articles/parallelize.html">How to parrallelize R functions with HLSGUtils package?</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to parrallelize R functions with HLSGUtils package?</h1>
            
      
      
      <div class="hidden name"><code>parallelize.Rmd</code></div>

    </div>

    
    
<p>Suppose we want to run different linear models on a dataset. We can write it with a for loop in R, but as a result of many R functions working with one core, this process, It will eventually run on one core and is time-consuming. Another solution is to use multiprocess packages in R, like <code>parallel</code>. These packages are very good, but the time of the executions does not decrease linearly when we increase the computation cores. One solution is that we run our code in parallel in different R sessions manually, like the <code>Jobs</code> option in Rstudio. At first glance, this idea is hard to implement because we need to have different R scripts and run them simultaneously. The <code>HLSGUtils</code> package provides some functions to make this work simpler with dynamic system resource management of memory and thread options.</p>
<p>We will try to describe parallelization in <code>HLGSUtils</code> step-by-step. First, we need a base script that we want to run concurrently. A simple example is shown below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linear_fitter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
    x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
    x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
    x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="op">)</span>
  
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">formula</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span>
  
  <span class="fu">write_rds</span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"~/Desktop/fittel_lm_%s.rds"</span>,<span class="va">n</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s modeling was done with %s samples!"</span>, <span class="va">formula</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Save the script in some path like <code>~/Desktop/modeling.R</code> <code>linear_fitter</code> is only run in the R environment. We need to convert this function that is run from the command line. <code>function_to_Rscript</code> converts function to command line format. This function needs:</p>
<ul>
<li>
<code>function_from_source</code>: The path of the saved R function</li>
<li>
<code>function_name</code>: The name of the function in the source file</li>
<li>
<code>packages</code>: The packages that are needed to be called</li>
<li>
<code>arguments</code>: Names of function arguments</li>
<li>
<code>arguments_class</code>: arguments function class types</li>
<li>
<code>script_save_path</code>: The generated R script path</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">HLSGUtils</span><span class="op">)</span>

<span class="fu"><a href="../reference/function_to_Rscript.html">function_to_Rscript</a></span><span class="op">(</span>
  function_from_source <span class="op">=</span> <span class="st">"~/Desktop/modeling.R"</span>,
  function_name <span class="op">=</span> <span class="st">"linear_fitter"</span>, 
  packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"readr"</span>,<span class="st">"broom"</span><span class="op">)</span>,
  arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"formula"</span>,<span class="st">"n"</span><span class="op">)</span>,
  arguments_class  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="st">"integer"</span><span class="op">)</span>,
  script_save_path <span class="op">=</span> <span class="st">"~/Desktop/modeling_r_script.R"</span>
  <span class="op">)</span></code></pre></div>
<p>The resulted script is ready to run on the command line. The converted code can be found below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">############################################################</span>
<span class="co">#                      linear_fitter                       #</span>
<span class="co">############################################################</span>

<span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">args</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">)</span><span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'I think you forgot your parameters'</span><span class="op">)</span><span class="op">}</span>

<span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/flush.console.html" class="external-link">flush.console</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Load Libraries</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"~/Desktop/modeling.R"</span><span class="op">)</span>

<span class="co"># Add Function Its Arguments</span>
<span class="fu">linear_fitter</span><span class="op">(</span>
formula <span class="op">=</span> <span class="va">formula</span>,
n <span class="op">=</span> <span class="va">n</span>
<span class="op">)</span></code></pre></div>
<p><code>modeling_r_script.R</code> can be run in command line format by <code>Rscript --vanilla</code> command and set input arguments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">--vanilla</span> ~/Desktop/modeling_r_script.R y~x1 100</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "y~x1 modeling was done with 100 samples!"</span></span></code></pre></div>
<p>After running the command, the result table is:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="st">"~/Desktop/fittel_lm_100.rds"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span>
<span class="co">#&gt;   term        estimate std.error statistic  p.value</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)    2.99     0.088<span style="text-decoration: underline;">6</span>     33.7  1.09<span style="color: #949494;">e</span><span style="color: #BB0000;">-55</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> x1            -<span style="color: #BB0000;">0.190</span>    0.091<span style="text-decoration: underline;">9</span>     -<span style="color: #BB0000;">2.06</span> 4.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span></span></code></pre></div>
<p>Finally, we want to run multiple models in parallel. <code>parallel_rscripts</code> allows you to run R command line functions in parallel. It needs to set input arguments and system resource management thresholds.</p>
<ul>
<li>
<code>rscript_path</code>: The path of command line format script</li>
<li>
<code>args</code>: list of function arguments</li>
<li>
<code>used_memory_treshold</code>: The total percentage of system memory that is in use.</li>
<li>
<code>used_cpu_treshold</code>: The total percentage of threads that is in use.</li>
<li>
<code>sleep_time</code>: sleep time between two work in seconds</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sample_size</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span>
<span class="va">formulas</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y~x1"</span>, <span class="st">"y~x1+x2"</span>, <span class="st">"y~x1+x2+x3"</span><span class="op">)</span>
<span class="fu"><a href="../reference/parallel_rscripts.html">parallel_rscripts</a></span><span class="op">(</span>
  rscript_path <span class="op">=</span> <span class="st">"~/Desktop/modeling_r_script.R"</span>,
  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">formulas</span>, n <span class="op">=</span> <span class="va">sample_size</span><span class="op">)</span>,
  used_memory_treshold <span class="op">=</span> <span class="fl">80</span>,
  used_cpu_treshold <span class="op">=</span> <span class="fl">80</span>,
  sleep_time <span class="op">=</span> <span class="fl">5</span> <span class="op">)</span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ahmad Ehyaei, Maryam Shoai.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
